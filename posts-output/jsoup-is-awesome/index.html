<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Gowder&#39;s Tech Blog (!): For Clojure Webscraping, Try Jsoup!</title>
    <link rel="canonical" href="http://paultopia.github.io/posts-output/jsoup-is-awesome/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='//fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700' rel='stylesheet'
          type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Gowder&#39;s Tech Blog (!)</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/">Home</a></li>
                <li
                ><a href="/archives/">Archives</a></li>
                
                <li
                >
                <a href="/pages-output/about/">About</a>
                </li>
                
                <li><a href="/feed.xml">RSS</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                        More <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li class="dropdown-header">Links</li>
                        <li><a href="https://gowder.io">Moi</a></li>
                        <li><a href="https://github.com/paultopia">Github</a></li>
                        <li><a href="https://twitter.com/PaulGowder">Twitter</a></li>
                        <li><a href="http://www.linkedin.com/in/paulgowder">LinkedIn</a></li>
                        

                        
                        <li class="divider"></li>
                        <li class="dropdown-header">Recent Posts</li>
                        
                        <li><a href="/posts-output/jupyter-experiment-with-image/">Experimental post: jupyter notebook --&gt; cryogen post</a></li>
                        
                        <li><a href="/posts-output/jsoup-is-awesome/">For Clojure Webscraping, Try Jsoup!</a></li>
                        
                        <li><a href="/posts-output/clojure-java/">Understanding Java for Clojurists, side-by-side</a></li>
                        
                        

                        
                        <li class="divider"></li>
                        <li class="dropdown-header">Tags</li>
                        
                        <li><a href="/tags-output/game theory/">game theory</a></li>
                        
                        <li><a href="/tags-output/latex/">latex</a></li>
                        
                        <li><a href="/tags-output/cryogen/">cryogen</a></li>
                        
                        <li><a href="/tags-output/testing/">testing</a></li>
                        
                        <li><a href="/tags-output/clojure/">clojure</a></li>
                        
                        <li><a href="/tags-output/web/">web</a></li>
                        
                        <li><a href="/tags-output/machine-learning/">machine-learning</a></li>
                        
                        <li><a href="/tags-output/browsers/">browsers</a></li>
                        
                        <li><a href="/tags-output/postgresql/">postgresql</a></li>
                        
                        <li><a href="/tags-output/css/">css</a></li>
                        
                        <li><a href="/tags-output/java/">java</a></li>
                        
                        <li><a href="/tags-output/unicode/">unicode</a></li>
                        
                        <li><a href="/tags-output/osx/">osx</a></li>
                        
                        <li><a href="/tags-output/text-mining/">text-mining</a></li>
                        
                        <li><a href="/tags-output/haskell/">haskell</a></li>
                        
                        <li><a href="/tags-output/machinelearning/">machinelearning</a></li>
                        
                        <li><a href="/tags-output/flexbox/">flexbox</a></li>
                        
                        <li><a href="/tags-output/math/">math</a></li>
                        
                        <li><a href="/tags-output/shell/">shell</a></li>
                        
                        <li><a href="/tags-output/heroku/">heroku</a></li>
                        
                        <li><a href="/tags-output/blog/">blog</a></li>
                        
                        <li><a href="/tags-output/latin-1/">latin-1</a></li>
                        
                        <li><a href="/tags-output/reagent/">reagent</a></li>
                        
                        <li><a href="/tags-output/emacs/">emacs</a></li>
                        
                        <li><a href="/tags-output/datascience/">datascience</a></li>
                        
                        <li><a href="/tags-output/package management/">package management</a></li>
                        
                        <li><a href="/tags-output/git/">git</a></li>
                        
                        <li><a href="/tags-output/spacemacs/">spacemacs</a></li>
                        
                        <li><a href="/tags-output/functional programming/">functional programming</a></li>
                        
                        <li><a href="/tags-output/templates/">templates</a></li>
                        
                        <li><a href="/tags-output/r/">r</a></li>
                        
                        <li><a href="/tags-output/utf-8/">utf-8</a></li>
                        
                        <li><a href="/tags-output/object-oriented programming/">object-oriented programming</a></li>
                        
                        <li><a href="/tags-output/debugging/">debugging</a></li>
                        
                        <li><a href="/tags-output/meta/">meta</a></li>
                        
                        <li><a href="/tags-output/flask/">flask</a></li>
                        
                        <li><a href="/tags-output/markdown/">markdown</a></li>
                        
                        <li><a href="/tags-output/homebrew/">homebrew</a></li>
                        
                        <li><a href="/tags-output/devcards/">devcards</a></li>
                        
                        <li><a href="/tags-output/javascript/">javascript</a></li>
                        
                        <li><a href="/tags-output/system/">system</a></li>
                        
                        <li><a href="/tags-output/python/">python</a></li>
                        
                        <li><a href="/tags-output/webscraping/">webscraping</a></li>
                        
                        <li><a href="/tags-output/performance/">performance</a></li>
                        
                        <li><a href="/tags-output/closures/">closures</a></li>
                        
                        <li><a href="/tags-output/react/">react</a></li>
                        
                        <li><a href="/tags-output/data/">data</a></li>
                        
                        <li><a href="/tags-output/machine learning/">machine learning</a></li>
                        
                        <li><a href="/tags-output/algorithms/">algorithms</a></li>
                        
                        <li><a href="/tags-output/numpy/">numpy</a></li>
                        
                        <li><a href="/tags-output/clojurescript/">clojurescript</a></li>
                        
                        <li><a href="/tags-output/mustache/">mustache</a></li>
                        
                        <li><a href="/tags-output/test/">test</a></li>
                        
                        <li><a href="/tags-output/trees/">trees</a></li>
                        
                        
                    </ul>
                </li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-12">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">October 17, 2017</div>
        
    </div>
    <h2>For Clojure Webscraping, Try Jsoup!</h2>
</div>
<div>
    
     <p>When people want to do webscraping in Clojure, the standard recommendation/tutorial library is <a href='https://github.com/cgrand/enlive'>Enlive</a>. (<a href='http://masnun.com/2016/03/20/web-scraping-with-clojure.html'>Example</a>, <a href='http://ericsomdahl.github.io/posts/2015-03-07-gevents1.html'>and another</a>, and there are at least two scraping libraries built on top of Enlive, <a href='http://blog.shriphani.com/2016/01/25/pegasus-a-modular-durable-web-crawler-for-clojure/'>Pegasus</a> and <a href='https://github.com/nathell/skyscraper'>Skyscraper</a>.) </p><p>But Enlive doesn't seem to be really built for scraping. For example, it's very difficult to actually get the text (the rough equivalent of browser api <code>document.innerText</code>, minus ajax-loaded context) out of a html document, and when you can get text, it comes out badly formatted&mdash;e.g., if you just pull all the text from the body tag, you don't get spaces between things like table rows and columns.  The best I can come up with to get decently formatted text without just walking all the individual DOM nodes myself is the following tangled mess (where <code>html</code> is the Enlive html namespace and I've brought <code>replace</code> and <code>trim</code> in from clojure.string):</p><pre><code class="clojure">&#40;defn- space-out-punctuation &#91;text&#93; 
  &#40;replace text #&quot;&#40;&#91;.?!\&quot;,:;“”\&#41;\&#40;\&#91;\&#93;\{\}&#93;&#41;&quot; &quot;$1 &quot;&#41;&#41;

&#40;defn- space-out-caps-diff &#91;text&#93; 
  &#40;replace text #&quot;&#40;&#91;a-z&#93;&#41;&#40;&#91;A-Z&#93;&#41;&quot; &quot;$1 $2&quot;&#41;&#41;

&#40;defn- space-out-letter-digit &#91;text&#93; 
  &#40;replace text #&quot;&#40;\d&#41;&#40;&#91;a-zA-Z&#93;&#41;&quot; &quot;$1 $2&quot;&#41;&#41;

&#40;defn- de-whitespace &#91;text&#93;
  &#40;trim &#40;replace text #&quot;\s+&quot; &quot; &quot;&#41;&#41;&#41;

&#40;defn extract-text &#91;webpage&#93;
  &#40;-&gt; webpage
      &#40;html/select &#91;:body&#93;&#41;
      &#40;html/transform &#91;:img&#93; nil&#41;
      &#40;html/transform &#91;:script&#93; nil&#41;
      &#40;html/transform &#91;:style&#93; nil&#41;
      html/texts
      first
      space-out-punctuation
      space-out-caps-diff
      space-out-letter-digit
      de-whitespace&#41;&#41;
</code></pre><p>By contrast, if you go to Javaland and use <a href='https://jsoup.org/'>Jsoup</a>, extracting all the text from a parsed document is a simple method call. And the formatting isn't perfect, but it's better than I can do with all that ugly code with Enlive.</p><p>Similarly, suppose you want a list of links from your document.  That's pretty easy to do with Enlive... except if you want to resolve relative links to absolute links, e.g., for crawling, well, that requires pulling in a separate library to sort out the URLs and writing a few more functions.  (Fortunately, Chas Emerick has written a <a href='https://github.com/cemerick/url'>URL library</a>, and, like all of Chas's libraries, it works beautifully.)</p><p>With Jsoup, that's another simple tweak to a single method call.</p><p>What this amounts to is that 50 or so lines of code using Enlive turn into 22 lines of code with Jsoup.  Here is all the code you need to fetch a page (admittedly, this needs error handling for failed requests), get out the text, and get a list of links, resolved to absolute URLs, with titles for every link: </p><pre><code class="clojure">&#40;ns myscraper.core
  &#40;:import &#91;org.jsoup Jsoup&#93;&#41;&#41;

&#40;defn get-page-at-address &#91;address&#93;
  &#40;let &#91;conn &#40;Jsoup/connect address&#41;
        soup &#40;.get conn&#41;&#93;
    soup&#41;&#41;

&#40;defn extract-link-data &#91;link&#93;
  &#40;let &#91;linktext &#40;.text link&#41;
        address &#40;.attr link &quot;abs:href&quot;&#41;&#93;
    {:linktext linktext :address address}&#41;&#41;

&#40;defn extract-links &#91;soup&#93;
  &#40;let &#91;links &#40;.select soup &quot;a&quot;&#41;&#93;
    &#40;mapv extract-link-data links&#41;&#41;&#41;

&#40;defn fetch &#91;address&#93;
  &#40;let &#91;soup &#40;get-page-at-address address&#41;
        links &#40;extract-links soup&#41;
        text &#40;.text soup&#41;&#93;
    {:soup soup :links links :text text}&#41;&#41;
</code></pre><p>I'm really happy I finally took the trouble to get a handle on Clojure-Java interop&mdash;there are a lot of really nice Java libraries out there!<br /></p><p>Further reading: </p><ul><li><a href='https://github.com/mischov/reaver'>Reaver</a>, a library someone built to leverage Jsoup in Clojure.</li><li><a href='http://josf.info/blog/2014/10/02/practical-zippers-extracting-text-with-enlive/'>A blog post</a> with an example of the manually-walking-the-DOM strategy to get text with Enlive.</li></ul>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags-output/clojure/">clojure</a>
    
    <a href="/tags-output/java/">java</a>
    
    <a href="/tags-output/webscraping/">webscraping</a>
    
</div>


    <div id="prev-next">
        
        <a href="/posts-output/jupyter-experiment-with-image/">&laquo; Experimental post: jupyter notebook --&gt; cryogen post</a>
        
        
        <a class="right" href="/posts-output/clojure-java/">Understanding Java for Clojurists, side-by-side &raquo;</a>
        
    </div>

    


</div>

            </div>
        </div>
    </div>
    <footer>
        <p>Copyright &copy; 2016-2018 <a href="https://gowder.io">Paul Gowder</a>.</p>

        <p> All original content licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License</a>. </p>

        <p class="rc-scout"></p>
    </footer>
</div>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/js/highlight.pack.js" type="text/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>

<!-- HERE ARE A BUNCH OF PAUL CUSTOMIZATIONS -->
<!-- try to get heavy klipse stuff loaded only if post has executable content -->


<!-- ditto mathjax -->



<script async defer src="https://www.recurse-scout.com/loader.js?t=883fcbc53dcca6e2fc6b228efe240125"></script>
</body>
</html>

