<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Gowder&#39;s Tech Blog (!): I think I&#39;ve figured out how to change text encodings in the browser. I&#39;m not sure, because it&#39;s text encodings, but maybe?</title>
    <link rel="canonical" href="http://paultopia.github.io/posts-output/text-encoding-browser/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='//fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700' rel='stylesheet'
          type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Gowder&#39;s Tech Blog (!)</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/">Home</a></li>
                <li
                ><a href="/archives/">Archives</a></li>
                
                <li
                >
                <a href="/pages-output/about/">About</a>
                </li>
                
                <li><a href="/feed.xml">RSS</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                        More <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li class="dropdown-header">Links</li>
                        <li><a href="https://gowder.io">Moi</a></li>
                        <li><a href="https://github.com/paultopia">Github</a></li>
                        <li><a href="https://twitter.com/PaulGowder">Twitter</a></li>
                        <li><a href="http://www.linkedin.com/in/paulgowder">LinkedIn</a></li>
                        

                        
                        <li class="divider"></li>
                        <li class="dropdown-header">Recent Posts</li>
                        
                        <li><a href="/posts-output/jupyter-experiment-with-image/">Experimental post: jupyter notebook --&gt; cryogen post</a></li>
                        
                        <li><a href="/posts-output/jsoup-is-awesome/">For Clojure Webscraping, Try Jsoup!</a></li>
                        
                        <li><a href="/posts-output/clojure-java/">Understanding Java for Clojurists, side-by-side</a></li>
                        
                        

                        
                        <li class="divider"></li>
                        <li class="dropdown-header">Tags</li>
                        
                        <li><a href="/tags-output/game theory/">game theory</a></li>
                        
                        <li><a href="/tags-output/latex/">latex</a></li>
                        
                        <li><a href="/tags-output/cryogen/">cryogen</a></li>
                        
                        <li><a href="/tags-output/testing/">testing</a></li>
                        
                        <li><a href="/tags-output/clojure/">clojure</a></li>
                        
                        <li><a href="/tags-output/web/">web</a></li>
                        
                        <li><a href="/tags-output/machine-learning/">machine-learning</a></li>
                        
                        <li><a href="/tags-output/browsers/">browsers</a></li>
                        
                        <li><a href="/tags-output/postgresql/">postgresql</a></li>
                        
                        <li><a href="/tags-output/css/">css</a></li>
                        
                        <li><a href="/tags-output/java/">java</a></li>
                        
                        <li><a href="/tags-output/unicode/">unicode</a></li>
                        
                        <li><a href="/tags-output/osx/">osx</a></li>
                        
                        <li><a href="/tags-output/text-mining/">text-mining</a></li>
                        
                        <li><a href="/tags-output/haskell/">haskell</a></li>
                        
                        <li><a href="/tags-output/machinelearning/">machinelearning</a></li>
                        
                        <li><a href="/tags-output/flexbox/">flexbox</a></li>
                        
                        <li><a href="/tags-output/math/">math</a></li>
                        
                        <li><a href="/tags-output/shell/">shell</a></li>
                        
                        <li><a href="/tags-output/heroku/">heroku</a></li>
                        
                        <li><a href="/tags-output/blog/">blog</a></li>
                        
                        <li><a href="/tags-output/latin-1/">latin-1</a></li>
                        
                        <li><a href="/tags-output/reagent/">reagent</a></li>
                        
                        <li><a href="/tags-output/emacs/">emacs</a></li>
                        
                        <li><a href="/tags-output/datascience/">datascience</a></li>
                        
                        <li><a href="/tags-output/package management/">package management</a></li>
                        
                        <li><a href="/tags-output/git/">git</a></li>
                        
                        <li><a href="/tags-output/spacemacs/">spacemacs</a></li>
                        
                        <li><a href="/tags-output/functional programming/">functional programming</a></li>
                        
                        <li><a href="/tags-output/templates/">templates</a></li>
                        
                        <li><a href="/tags-output/r/">r</a></li>
                        
                        <li><a href="/tags-output/utf-8/">utf-8</a></li>
                        
                        <li><a href="/tags-output/object-oriented programming/">object-oriented programming</a></li>
                        
                        <li><a href="/tags-output/debugging/">debugging</a></li>
                        
                        <li><a href="/tags-output/meta/">meta</a></li>
                        
                        <li><a href="/tags-output/flask/">flask</a></li>
                        
                        <li><a href="/tags-output/markdown/">markdown</a></li>
                        
                        <li><a href="/tags-output/homebrew/">homebrew</a></li>
                        
                        <li><a href="/tags-output/devcards/">devcards</a></li>
                        
                        <li><a href="/tags-output/javascript/">javascript</a></li>
                        
                        <li><a href="/tags-output/system/">system</a></li>
                        
                        <li><a href="/tags-output/python/">python</a></li>
                        
                        <li><a href="/tags-output/webscraping/">webscraping</a></li>
                        
                        <li><a href="/tags-output/performance/">performance</a></li>
                        
                        <li><a href="/tags-output/closures/">closures</a></li>
                        
                        <li><a href="/tags-output/react/">react</a></li>
                        
                        <li><a href="/tags-output/data/">data</a></li>
                        
                        <li><a href="/tags-output/machine learning/">machine learning</a></li>
                        
                        <li><a href="/tags-output/algorithms/">algorithms</a></li>
                        
                        <li><a href="/tags-output/numpy/">numpy</a></li>
                        
                        <li><a href="/tags-output/clojurescript/">clojurescript</a></li>
                        
                        <li><a href="/tags-output/mustache/">mustache</a></li>
                        
                        <li><a href="/tags-output/test/">test</a></li>
                        
                        <li><a href="/tags-output/trees/">trees</a></li>
                        
                        
                    </ul>
                </li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-12">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">September 5, 2017</div>
        
    </div>
    <h2>I think I&#39;ve figured out how to change text encodings in the browser. I&#39;m not sure, because it&#39;s text encodings, but maybe?</h2>
</div>
<div>
    
     <p>So I'm working on a slightly irrational project, namely, extracting citations from MS-Word formatted law review articles and generating bibtex download + on-screen display, in pure client-side Javascript.<br /></p><p>This has a lot of steps to it, but the browser is a surprisingly good platform for doing it (and an unbeatable platform for delivery).</p><p>Basically, a docx file is a zip file with a different extension, and each of the files inside is an XML file encoded in Latin-1 (or the <a href='https://stackoverflow.com/a/19111140/4386239'>slightly different windows-1252</a>, but either way, not nice sensible UTF-8, which is why you get a bunch of <a href='https://en.wikipedia.org/wiki/Mojibake'>mojibake</a> whenever you copy text from Word into anything else).  So this means there are three steps to making it into something useful:</p><p>Step 1: Get the contents unzipped out of the docx format.  <a href='https://gildas-lormeau.github.io/zip.js/'>Zipjs</a> is a very good zip library that handles this task with no problem, it's as simple as hanging a listener on a file upload form that converts to a blob and then passes to <code>zip.BlobReader</code>.</p><p>Step 2: Parse the XML.  It might be surprising, but it shouldn't be, to learn that the browser is a really good platform for XML parsing. Since, after all, parsing XML is <a href='https://softwareengineering.stackexchange.com/questions/93296/relation-and-differences-between-sgml-xml-html-and-xhtml'>basically the same task</a> as parsing HTML. It's as straightforward as:</p><pre><code class="javascript">function parseXML&#40;xmlstring&#41;{
    var parser = new DOMParser&#40;&#41;;
    return parser.parseFromString&#40;xmlstring, &quot;text/xml&quot;&#41;;}
</code></pre><p>and then you can use normal DOM methods and attributes to navigate and get things from the XML, just as if it were a HTML page.</p><p>Step 3. Display some intermediate results on a web page. You've got strings, display them.</p><p>Step 4. Convert the crazy windows encoding to something more rational. This is the fun part. </p><p>Ideally, we'd do this before step 2, but we can't have everything. As it turns out, the browser is perfectly capable of identifying cray Microsoft encodings when they come from a docx file and parsing the XML/displaying them properly on screen without conversion. I'm not sure whether this is Zipjs or something in Chrome performing this magic (or being told to do so by something in the docx/underlying XML), but it works, so I'm not going to look a gift horse in the mouth.</p><p>(Incidentally, if you open up the Javascript console and look at <code>document.characterSet</code>, you'll see the character encoding Chrome thinks it's using; for text parsed from at least the docx on my machine it sees windows-1252, and manages to display special characters correctly, including the usually problematic ones like en-dashes.)</p><p>However, like I said, I want to ultimately give the user a bibtex file to download. Maybe other downloads too. And I simply will <em>not</em> have those things be in windows-1252 or latin-1 or any other such ridiculousness. UTF-8 or bust. </p><p>It turns out that there's no good information on how to do this in the browser. There are a couple of <a href='https://stackoverflow.com/a/5396742/4386239'>obsolete Stack Overflow answers</a> that essentially tell you to use <code>decodeURIComponent&#40;escape&#40;string&#41;&#41;;</code> or maybe <code>unescape&#40;encodeURIComponent&#40;originalstring&#41;&#41;;</code>, but neither actually works. </p><p>Fortunately, it looks like you can coerce a string encoding change in the browser Blob constructor. (At least, this works on my machine, in the latest version of Chrome). </p><p>So here's my solution. This <em>appears</em> to work to take an in-memory string in windows-1252 and produce a link to a downloadable text file in UTF-8, as desired: </p><pre><code class="javascript">function experimentalUTF8Download&#40;latin1string&#41;{
    var b = new Blob&#40;&#91;latin1string&#93;, {type: &quot;text/plain;charset=UTF-8&quot;}&#41;;
    var linkurl = URL.createObjectURL&#40;b&#41;;
    var a = document.createElement&#40;'a'&#41;;
    var linkText = document.createTextNode&#40;&quot;foo&quot;&#41;;
    a.appendChild&#40;linkText&#41;;
    a.href = linkurl;
    document.body.appendChild&#40;a&#41;;
    }
</code></pre><p>The key is in line 2: you coerce the character set of the Blob you're creating to be UTF-8.</p><h3><a name="evidence&#95;that&#95;this&#95;works?"></a>Evidence that this works?</h3><p>Like I said, this <em>appears</em> to work. Because there isn't exactly a direct way of telling, I used a couple of different methods to get what I consider to be circumstantial evidence that this is the correct encoding: </p><p><strong>First:</strong>  When I open the resulting file in the browser, it comes out garbled (with mojibake in the appropriate places, like those en-dashes I mentioned before), and <code>document.characterSet</code> is still "windows-1252". I infer from this that Chrome doesn't know to change the characterset from the previous html file, but it can't parse the new file&mdash;because it isn't windows-1252 any more!</p><p><strong>Second:</strong>  Reading the file in Python3 with no arguments to the <code>open&#40;&#41;</code> constructor <a href='https://docs.python.org/3/library/functions.html#open'>defaults to your platform's default characterset</a> (the output of <code>locale.getpreferredencoding&#40;&#41;</code>), which in my case is utf-8. </p><p>I can read the file in Python3 without passing any arguments, i.e., </p><pre><code class="python">with open&#40;&quot;foo.txt&quot;&#41; as f:
    foo = f.read&#40;&#41;
foo
</code></pre><p>and the en-dashes come out looking right in the REPL. </p><p><strong>Third:</strong> When I try to open the file as windows-1252, Python3 throws a <code>UnicodeDecodeError</code> error, and when I try to open it as latin-1 (the other obvious suspect) it doesn't throw, but it does mojibake at me. </p><p>These three pieces of evidence seem to very strongly suggest that I've successfully coerced the encodings in the Blob for download.  So: YAY!! Take that, obsolete Microsoft encodings!</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags-output/web/">web</a>
    
    <a href="/tags-output/browsers/">browsers</a>
    
    <a href="/tags-output/unicode/">unicode</a>
    
    <a href="/tags-output/latin-1/">latin-1</a>
    
    <a href="/tags-output/utf-8/">utf-8</a>
    
    <a href="/tags-output/javascript/">javascript</a>
    
</div>


    <div id="prev-next">
        
        <a href="/posts-output/clojure-java/">&laquo; Understanding Java for Clojurists, side-by-side</a>
        
        
        <a class="right" href="/posts-output/flask-heroku-postgres/">The Easiest Possible Way to Throw a Webapp Online (Flask + Heroku + Postgres) &raquo;</a>
        
    </div>

    


</div>

            </div>
        </div>
    </div>
    <footer>
        <p>Copyright &copy; 2016-2018 <a href="https://gowder.io">Paul Gowder</a>.</p>

        <p> All original content licensed under a <a rel="license" href="http://creativecoa rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png" /></a> mmons.org/licenses/by-nc-nd/4.0/">Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License</a>. </p>

        <p class="rc-scout"></p>
    </footer>
</div>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/js/highlight.pack.js" type="text/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>

<!-- HERE ARE A BUNCH OF PAUL CUSTOMIZATIONS -->
<!-- try to get heavy klipse stuff loaded only if post has executable content -->


<!-- ditto mathjax -->



<script async defer src="https://www.recurse-scout.com/loader.js?t=883fcbc53dcca6e2fc6b228efe240125"></script>
</body>
</html>

